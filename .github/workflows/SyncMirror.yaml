name: 'Sync Mirror'

on:
  push:
    branches: [ 'main', 'release/*' ]

permissions:
  actions: read
  contents: write
  packages: write

defaults:
  run:
    shell: pwsh


jobs:
  SyncRepository:
    runs-on: ubuntu-latest
    steps:
      - name: Logging
        id: log
        run : | 
          Write-Host "GITHUB_REF: $ENV:GITHUB_REF"
          Write-Host "GITHUB_REFNAME: $ENV:GITHUB_REFNAME"
          Write-Host "GITHUB_SHA: $ENV:GITHUB_SHA"
          Write-Host "GITHUB_REPOSITORY: $ENV:GITHUB_REPOSITORY"
          Write-Host "GITHUB_ACTOR: $ENV:GITHUB_ACTOR"
          Write-Host "GITHUB_REPOSITORY_URL: $ENV:GITHUB_REPOSITORY_URL"
      - name: Checkout
        uses: actions/checkout@v3
        with:
          ref: ${{ env.GITHUB_REF }}
          repository: aholstrup1/AlAppExtensions-Mirror
          token: ${{ secrets.PAT }}
          fetch-depth: 0

      - name: Pull Changes from upstream
        id: Sync
        run : |
          $Branch = $ENV:GITHUB_REF -replace "refs/heads/"
          $UpstreamRepo = $ENV:GITHUB_REPOSITORY_URL

          Write-Host "Adding upstream"
          git remote add upstream $UpstreamRepo

          git fetch --all --prune
          git pull upstream $Branch

          Write-Host "Pushing $Branch to origin"
          git push origin $Branch